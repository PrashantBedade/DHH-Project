<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }

        .dashboard {
            display: flex;
            max-height: 100%;
        }

        .sidebar {
            width: 25%;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: orange;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-size: 20px;
        }

        .sidebar a:hover {
            background-color: #34495e;
        }

        .main {
            flex-grow: 1;
            padding: 20px;
            background-color: #ecf0f1;
            width: 100%;
            height: 95vh;
        }

        .main h1 {
            margin-bottom: 20px;
        }

        .data-section {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: none;
            width: 90%;
        }

        .data-section.active {
            display: block;
        }

        .information {
            display: flex;
            flex-direction: row;
        }

        .info1,
        .info2 {
            display: flex;
            flex-direction: column;
            width: 50%;
        }

        #information input {
            height: 20px;
            width: 90%;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        label {
            display: block;
            margin-bottom: 0px;
            font-weight: bold;
            font-size: 18px;
        }
        select, input[type="date"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input:hover, select:hover{
box-shadow: 1px 1px 2px #000;        }
        .time-slots {
            display: flex;
            overflow-x: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 20px;
            gap: 5px;
        }
        .time-slot {
            padding: 10px;
            background: #e0f7fa;
            border: 1px solid #00796b;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .time-slot.disabled {
            background: #ef9a9a;
            color: #fff;
            cursor: not-allowed;
        }
        .time-slot.selected {
            background: #00796b;
            color: #fff;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: #00796b;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn:hover {
            background: #004d40;
        }
        .container {
            background-color: white;
            padding: 20px;
            display: none;
        }

        .container.active {
            display: block;
        }

        table {
            border-collapse: collapse;
            width: 80%;
            margin: auto;
        }
        
        table,
        th,
        td {
            padding: 10px;
            border: 1px solid;
            font-size: 20px;
        }

        .History h3,
        .appointment h3 {
            text-align: center;
            font-size: 30px;
        }

        .appmix {
            display: flex;
            flex-direction: row;
        }
        #editbtn{
            text-align: center;
            margin:30px auto;
            align-items: center;
            display: block;
            font-size: 20px;
            font-weight: bold;
            background-color: #1F89E5;
            color: #fff;
            border-radius: 10px;
            height: 40px;
        }
        #appointment-history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

#appointment-history-table th, #appointment-history-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
}

#appointment-history-table th {
    background-color: #1F89E5;
}

.data-section {
    padding: 20px;
    padding-bottom: 10px;
}

.scrollable-table {
    max-height: 70vh; /* Set your desired height */
    overflow-y: auto;  /* Enables vertical scrolling */
    border: 1px solid #ccc; /* Optional: to define a border around the table */
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #000000;
}

th {
    background-color: #1F89E5;
    color: #fff;
    border: 1px solid black;
}
#patientID{
    font-size: 20px;
    background-color: #2c3e50;
    color: orange;
    margin: 0px auto;
    text-align: center;
    padding: 5px;
    width: 50%;
    border: none;

}
.idclass{
    display: flex;
    flex-wrap: wrap;
    font-size: 20px;
    margin: 10px auto;
}
.logout-btn, .home-page-btn {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .home-page-btn {
            background-color: #48bb78;
        }

        .home-page-btn:hover {
            background-color: #38a169;
        }
        button:hover{
            box-shadow: 2px 2px 2px #000;
        }

    </style>
</head>

<body>
    <div class="dashboard">
        <div class="sidebar">
            <h2 style="font-size: 30px;">Welcome</h2>
            <div class="idclass">
            <span id="patient_ID">Patient ID:</span>
            <input type="text" name="patientID" id="patientID" disabled>
</div>
            <a href="#" id="info-link">Information</a>
            <a href="#" id="appointment-link">Appointment Booking</a>

            <a href="#" id="history-link">History</a>
            <button id="logout-btn" class="logout-btn">Logout</button>
            <button id="homePageBtn" class="home-page-btn">Homepage</button>
        
        </div>
        <div class="main">
            <h1>Patient Dashboard</h1>
            <div class="data-section" id="information">
                <div id="infromation" class="information">
                    <div class="info1">
                        <label for="name">Patient Name:</label>
                        <input type="text" name="name" id="name">

                        <label for="age">Age:</label>
                        <input type="text" name="age" id="age">

                        <label for="dob">DoB:</label>
                        <input type="text" name="dob" id="dob">

                        <label for="address">Address:</label>
                        <input type="text" name="address" id="address">

                        <label for="state">State:</label>
                        <input type="text" name="state" id="state">

                        <label for="city">City:</label>
                        <input type="text" name="city" id="city">
                    </div>

                    <div class="info2">
                        <label for="height">Height:</label>
                        <input type="text" name="height" id="height">

                        <label for="weight">Weight:</label>
                        <input type="text" name="weight" id="weight">

                        <label for="disability">Disability:</label>
                        <input type="text" name="disability" id="disability">

                        <label for="mobile">Mobile Number:</label>
                        <input type="text" name="mobile" id="mobile">

                        <label for="family">Family Mobile Number:</label>
                        <input type="text" name="family" id="family">

                        <label for="email">Email:</label>
                        <input type="text" name="email" id="email">
                    </div>
                </div>
                <button id="editbtn" type="button">Edit Information</button>
            </div>
            <div class="container" id="container">
                <h2>Appointment Booking</h2>
                <form id="appointment-form">
                    <div>
                        <label for="Hospitals">Hospital</label>
                        <select name="Hospitals" id="Hospitals">
                            <option value="Digital Health Hub">Digital Health Hub</option>
                        </select>
                    </div>
        
                    <div>
                        <label for="Doctors">Doctor</label>
                        <select name="Doctors" id="Doctors">
                            <option value="">Select Doctor</option>
                        </select>
                    </div>
        
                    <div>
                        <label for="Date">Date</label>
                        <input type="date" id="Date" name="Date" required>
                    </div>
        
                    <div>
                        <label>Time Slot</label>
                        <div class="time-slots" id="time-slots">
                            <!-- Time slots will be dynamically generated here -->
                        </div>
                    </div>
        
                    <button type="button" class="btn" id="book-appointment">Book Appointment</button>
                </form>
            </div>
            <div class="data-section" id="appointmentbooked">
                <h3>Appointment</h3>
                <div class="hospital appmix">
                    <strong>Hospital : </strong>
                    <p>Hospital1</p>
                </div>
                <div class="Doctor appmix">
                    <strong>Doctor : </strong>
                    <p>Doctor1</p>
                </div>
                <div class="Date appmix">
                    <strong>Date : </strong>
                    <p>Date</p>
                </div>
                <div class="Time appmix">
                    <strong>Time : </strong>
                    <p>Time</p>
                </div>
            </div>

            


            <div class="data-section" id="history">
                <h2>History of Appointments</h2>
                <div class="scrollable-table">
                    <table>
                        <tr>
                            <th>Hospital</th>
                            <th>Doctor</th>
                            <th>Date</th>
                            <th>Time</th>
                        </tr>
                        <!-- Table rows will be dynamically added here -->
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // Check if the user is logged in
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert('Please Login Before Use. Redirecting to login.');
            window.location.href = 'login.html';
        }

document.getElementById("homePageBtn").onclick = function() {
        window.location.href = "index.html"; // Replace 'index.html' with your homepage URL
    };

    document.getElementById('logout-btn').addEventListener('click', function () {
            // Remove user session data from localStorage or sessionStorage
            localStorage.removeItem('authToken');  // Example using localStorage, change as per your implementation
            sessionStorage.removeItem('authToken'); // If you use sessionStorage

            // Redirect to the login page after logout
            window.location.href = 'login.html'; // Replace with the actual login page URL
        });

    
        // Section Navigation
        const infoLink = document.getElementById("info-link");
        const appointmentLink = document.getElementById("appointment-link");
        const historyLink = document.getElementById("history-link");
    
        const informationSection = document.getElementById("information");
        const appointmentSection = document.getElementById("container");
        const historySection = document.getElementById("history");
    
        function hideAllSections() {
            informationSection.classList.remove("active");
            appointmentSection.classList.remove("active");
            historySection.classList.remove("active");
        }
    
        infoLink.addEventListener("click", (e) => {
            e.preventDefault();
            hideAllSections();
            informationSection.classList.add("active");
        });
    
        appointmentLink.addEventListener("click", (e) => {
            e.preventDefault();
            hideAllSections();
            appointmentSection.classList.add("active");
        });
    
        historyLink.addEventListener("click", (e) => {
            e.preventDefault();
            hideAllSections();
            historySection.classList.add("active");
            fetchAppointmentHistory(); // Fetch history when "History" section is clicked
        });
    
        // Default section to display
        informationSection.classList.add("active");
    
        // Appointment Booking Logic
        document.addEventListener("DOMContentLoaded", () => {
    const doctorSelect = document.getElementById("Doctors");
    const dateInput = document.getElementById("Date");
    const timeSlotsContainer = document.getElementById("time-slots");
    const bookButton = document.getElementById("book-appointment");

    // Restrict date input to today's date and beyond
    const today = new Date();
    dateInput.min = today.toISOString().split("T")[0];

    // Fetch available doctors when the page loads
    fetch("http://localhost:5011/api/doctors/available")
        .then(response => response.json())
        .then(doctors => {
            doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
            doctors.forEach(doctor => {
                const option = document.createElement("option");
                option.value = doctor.doctorID;
                option.textContent = doctor.name;
                doctorSelect.appendChild(option);
            });
        })
        .catch(error => console.error("Error fetching doctors:", error));

    // Generate available time slots when doctor and date are selected
    dateInput.addEventListener("change", generateTimeSlots);
    doctorSelect.addEventListener("change", generateTimeSlots);

    function generateTimeSlots() {
        const selectedDoctor = doctorSelect.value;
        const selectedDate = dateInput.value;

        if (!selectedDoctor || !selectedDate) {
            timeSlotsContainer.innerHTML = ""; // Clear time slots if no doctor or date selected
            return;
        }

        // Fetch available time slots from the API
        fetch(`http://localhost:5011/api/appointments/slots?doctorID=${selectedDoctor}&date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                timeSlotsContainer.innerHTML = ""; // Clear previous slots

                const availableSlots = data.availableSlots || [];
                const currentDate = new Date();
                const isToday = selectedDate === currentDate.toISOString().split("T")[0];

                availableSlots.forEach(slot => {
                    const [hour, minute] = slot.split(":").map(Number);
                    const slotDate = new Date(selectedDate);
                    slotDate.setHours(hour, minute, 0);

                    // Exclude past times if the selected date is today
                    if (!isToday || slotDate > currentDate) {
                        const slotDiv = document.createElement("div");
                        slotDiv.textContent = slot;
                        slotDiv.className = "time-slot";
                        slotDiv.addEventListener("click", () => {
                            document.querySelectorAll(".time-slot").forEach(slot => slot.classList.remove("selected"));
                            slotDiv.classList.add("selected");
                        });
                        timeSlotsContainer.appendChild(slotDiv);
                    }
                });

                if (timeSlotsContainer.innerHTML === "") {
                    timeSlotsContainer.innerHTML = "<p>No available slots for the selected date.</p>";
                }
            })
            .catch(error => console.error("Error fetching time slots:", error));
    }

    // Book the appointment
    bookButton.addEventListener("click", () => {
        const selectedDoctor = doctorSelect.value;
        const selectedDate = dateInput.value;
        const selectedTimeSlot = document.querySelector(".time-slot.selected");

        if (!selectedDoctor || !selectedDate || !selectedTimeSlot) {
            alert("Please fill out all fields and select an available time slot.");
            return;
        }

        const appointmentData = {
            hospital: "Digital Health Hub", // Assuming a single hospital
            doctorID: selectedDoctor,
            date: selectedDate,
            time: selectedTimeSlot.textContent,
        };

        // Send booking request to the API
        fetch("http://localhost:5011/api/appointments/book", {
            method: "POST",
            headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify(appointmentData),
        })
            .then(response => {
                if (response.ok) {
                    response.blob().then(blob => {
                        const contentType = response.headers.get("Content-Type");
                        if (contentType && contentType.includes("application/pdf")) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement("a");
                            link.href = url;
                            link.download = `Appointment-${appointmentData.hospital}-${appointmentData.date}.pdf`;
                            link.click();
                            URL.revokeObjectURL(url);
                            location.reload();
                        } else {
                            throw new Error("The server did not return a PDF file.");
                        }
                    });
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.message) {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error("Error booking appointment:", error);
                alert("Failed to download the PDF. Please try again.");
            });
    });
});

        // Function to fetch and populate patient details
        const fetchPatientDetails = async () => {
            try {
                const token = localStorage.getItem('authToken');  // Updated token key
                if (!token) {
                    alert("Please log in first");
                    return;
                }
    
                const response = await fetch('http://localhost:5011/api/patient/details', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
    
                if (response.ok) {
                    const patient = await response.json();
    
                    // Populate form fields with fetched patient data
                    document.getElementById('patientID').value = patient.patientID;
                    document.getElementById('name').value = patient.name;
                    document.getElementById('age').value = patient.age;
                    document.getElementById('dob').value = patient.dob;
                    document.getElementById('address').value = patient.address;
                    document.getElementById('state').value = patient.state;
                    document.getElementById('city').value = patient.city;
                    document.getElementById('height').value = patient.height;
                    document.getElementById('weight').value = patient.weight;
                    document.getElementById('disability').value = patient.disability;
                    document.getElementById('mobile').value = patient.mobile;
                    document.getElementById('family').value = patient.family;
                    document.getElementById('email').value = patient.email;
                } else {
                    alert('Failed to fetch patient details');
                }
            } catch (error) {
                console.error('Error fetching patient details:', error);
                alert('Error fetching patient details');
            }
        };
    
        // Call the fetch function when the page loads
        window.onload = fetchPatientDetails;
    
        // Function to edit patient details
        const editPatientDetails = async () => {
            try {
                const token = localStorage.getItem('authToken');  // Updated token key
                if (!token) {
                    alert("Please log in first");
                    return;
                }
    
                const updatedDetails = {
                    name: document.getElementById('name').value,
                    age: document.getElementById('age').value,
                    dob: document.getElementById('dob').value,
                    address: document.getElementById('address').value,
                    state: document.getElementById('state').value,
                    city: document.getElementById('city').value,
                    height: document.getElementById('height').value,
                    weight: document.getElementById('weight').value,
                    disability: document.getElementById('disability').value,
                    mobile: document.getElementById('mobile').value,
                    family: document.getElementById('family').value,
                    email: document.getElementById('email').value,
                };
    
                const response = await fetch('http://localhost:5011/api/patient/edit', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedDetails),
                });
    
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);  // Show success message
                } else {
                    alert('Failed to update patient details');
                }
            } catch (error) {
                console.error('Error updating patient details:', error);
                alert('Error updating patient details');
            }
        };
    
        // Attach the edit function to the button click event
        document.getElementById('editbtn').addEventListener('click', (e) => {
            e.preventDefault();  // Prevent default form submission
            editPatientDetails();
        });
    
        // Fetch and display appointment history
        const fetchAppointmentHistory = async () => {
    try {
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert("Please log in first");
            return;
        }

        const response = await fetch('http://localhost:5011/api/patient/history', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
        });

        if (response.ok) {
            const appointments = await response.json();
            const historyTable = document.querySelector('#history table');
            historyTable.innerHTML = `
                <tr>
                    <th>Hospital</th>
                    <th>Doctor</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            `; // Reset table headers

            appointments.forEach(appointment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${appointment.hospital}</td>
                    <td>${appointment.doctorName}</td>  <!-- Using doctorName instead of doctorID -->
                    <td>${appointment.date}</td>
                    <td>${appointment.time}</td>
                `;
                historyTable.appendChild(row);
            });
        } else {
            alert('There is no appointment Histrory of you');
        }
    } catch (error) {
        console.error('Error fetching appointment history:', error);
        alert('Error fetching appointment history');
    }
};
    </script>
 </body>

</html>


